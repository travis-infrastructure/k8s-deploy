dist: bionic
addons:
  snaps:
  - name: google-cloud-sdk
    confinement: classic
  - name: fluxctl
    confinement: classic
  - name: kubectl
    confinement: classic
services:
- docker
env:
  global:
  - CLOUDSDK_CORE_DISABLE_PROMPTS=1
before_install:
- openssl aes-256-cbc -K $encrypted_03c7ca1eb666_key -iv $encrypted_03c7ca1eb666_iv
  -in secret.tar.enc -out secret.tar -d
- export PATH=$PATH:/snap/google-cloud-sdk/current/bin
- tar xvf secret.tar && mv key /tmp/ssh_key
- eval "$(ssh-agent -s)"
- chmod 600 /tmp/ssh_key
- ssh-add /tmp/ssh_key
- if [[ "${PROJECT}" == "production" ]]; then export GCP_ZONE="${GCP_ZONE:-us-east1}; 
  gcloud -q auth activate-service-account --key-file ${TRAVIS_BUILD_DIR}/client-secret-production.json";
  else export GCP_ZONE="${GCP_ZONE:-us-east4}";
  gcloud -q auth activate-service-account --key-file ${TRAVIS_BUILD_DIR}/client-secret-staging.json; fi
- gcloud -q config set project travis-ci-${PROJECT}-services-1
- gcloud -q config set compute/zone ${GCP_ZONE}
- export GKE_CLUSTER="${GKE_CLUSTER:-travis-ci-services-1}"
- gcloud container clusters get-credentials ${GKE_CLUSTER}
- gcloud auth configure-docker
install: true
jobs:
  include:
  - stage: ":ship: it"
    script: make ship
