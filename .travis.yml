dist: jammy

vm:
  size: large

services:
- docker
env:
  global:
  - CLOUDSDK_CORE_DISABLE_PROMPTS=1
  - PROJECT=staging
before_install:
- echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee -a /etc/apt/sources.list.d/google-cloud-sdk.list
- curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key --keyring /usr/share/keyrings/cloud.google.gpg add -
- wget -O- https://apt.releases.hashicorp.com/gpg | sudo gpg --dearmor -o /usr/share/keyrings/hashicorp-archive-keyring.gpg
- echo "deb [signed-by=/usr/share/keyrings/hashicorp-archive-keyring.gpg] https://apt.releases.hashicorp.com $(lsb_release -cs) main" | sudo tee /etc/apt/sources.list.d/hashicorp.list
- sudo apt-key adv --keyserver keyserver.ubuntu.com --recv-keys 7123CB760FF18869
- sudo apt update
- sudo apt-get -y install apt-transport-https ca-certificates gnupg curl sudo google-cloud-cli vault
- vault login "${VAULT_TOKEN}"
- vault kv get -field=secret "gcp/gcp-k8s-sa-${PROJECT}" > client-secret.json;
- curl -sLO http://ppa.launchpad.net/rmescandon/yq/ubuntu/pool/main/y/yq/yq_3.1-2_amd64.deb && sudo dpkg -i yq_3.1-2_amd64.deb && rm -f yq_3.1-2_amd64.deb
- if [[ "${PROJECT}" == "production" ]]; then export GCP_ZONE="${GCP_ZONE:-us-east1}";
  export GKE_CLUSTER="${GKE_CLUSTER:-travis-ci-services}";
  APPS_CLUSTER=$(yq r ./apps.yaml ${DEPLOYMENT_NAME}-${PROJECT}.cluster);
  if [[ "xx${APPS_CLUSTER}" != "xx" ]]; then GKE_CLUSTER=${APPS_CLUSTER}; fi;
  export GCE_PROJECT="travis-ci-prod-services-1";
  else
  export GCP_ZONE="${GCP_ZONE:-us-east4}";
  export GKE_CLUSTER="${GKE_CLUSTER:-travis-ci-services-1}";
  export GCE_PROJECT="travis-ci-staging-services-1"; fi
- gcloud -q auth activate-service-account --key-file "${TRAVIS_BUILD_DIR}/client-secret.json";
- gcloud auth configure-docker
- vault kv get -field=secret "gcp/k8s-deploy-ssh-key" > /tmp/ssh_key
- eval "$(ssh-agent -s)"
- chmod 600 /tmp/ssh_key
- ssh-add /tmp/ssh_key
install: true
jobs:
  include:
  - stage: ":ship: it"
    script: 
    - make ship
